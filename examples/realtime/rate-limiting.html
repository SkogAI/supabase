<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Realtime - Rate Limiting Example</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .status {
            padding: 10px;
            margin: 15px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
        }
        .events {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background: #fafafa;
        }
        .event {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            background: white;
            border-left: 3px solid #4CAF50;
        }
        .event.insert { border-left-color: #4CAF50; }
        .event.update { border-left-color: #2196F3; }
        .event.delete { border-left-color: #f44336; }
        .event-type {
            font-weight: bold;
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
        }
        .event-time {
            color: #999;
            font-size: 11px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-top: 10px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .controls {
            margin: 20px 0;
        }
        .rate-limit-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .stat {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Supabase Realtime - Rate Limiting Example</h1>
        <p>This example demonstrates realtime subscriptions with rate limiting best practices.</p>
        
        <div class="info-box">
            <strong>Rate Limits (Default):</strong>
            <ul>
                <li>100 concurrent connections per client</li>
                <li>100 channels per connection</li>
                <li>Messages throttled per channel (configurable)</li>
            </ul>
        </div>

        <div id="status" class="status disconnected">‚ö†Ô∏è Not connected</div>

        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="eventCount">0</div>
                <div class="stat-label">Events Received</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="channelCount">0</div>
                <div class="stat-label">Active Channels</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="throttledCount">0</div>
                <div class="stat-label">Throttled Updates</div>
            </div>
        </div>

        <div class="controls">
            <button id="connectBtn">Connect</button>
            <button id="disconnectBtn" disabled>Disconnect</button>
            <button id="clearBtn">Clear Events</button>
        </div>

        <div class="rate-limit-info">
            <strong>üí° Tip:</strong> This example uses debouncing to prevent excessive UI updates.
            Even if database changes happen rapidly, UI updates are throttled to 500ms.
        </div>

        <h3>Realtime Events:</h3>
        <div class="events" id="events">
            <em>No events yet. Connect and make changes to see realtime updates...</em>
        </div>
    </div>

    <script>
        // Initialize stats
        let eventCount = 0;
        let throttledCount = 0;
        let activeChannels = [];
        
        // Configuration
        const SUPABASE_URL = 'http://localhost:8000';
        const SUPABASE_ANON_KEY = 'your-anon-key-here';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let channel = null;
        
        // Debounce helper to limit UI update frequency
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                throttledCount++;
                updateStats();
            };
        }
        
        // Update UI with new event
        function addEvent(type, data) {
            eventCount++;
            updateStats();
            
            const eventsDiv = document.getElementById('events');
            const eventDiv = document.createElement('div');
            eventDiv.className = `event ${type.toLowerCase()}`;
            
            const now = new Date().toLocaleTimeString();
            eventDiv.innerHTML = `
                <span class="event-type">${type}</span>
                <span class="event-time">${now}</span>
                <pre style="margin: 5px 0 0 0; font-size: 12px;">${JSON.stringify(data, null, 2)}</pre>
            `;
            
            eventsDiv.insertBefore(eventDiv, eventsDiv.firstChild);
            
            // Limit displayed events to prevent memory issues
            if (eventsDiv.children.length > 50) {
                eventsDiv.removeChild(eventsDiv.lastChild);
            }
        }
        
        // Debounced version to prevent excessive DOM updates
        const addEventDebounced = debounce(addEvent, 500);
        
        // Update statistics
        function updateStats() {
            document.getElementById('eventCount').textContent = eventCount;
            document.getElementById('channelCount').textContent = activeChannels.length;
            document.getElementById('throttledCount').textContent = throttledCount;
        }
        
        // Update connection status
        function updateStatus(connected) {
            const statusDiv = document.getElementById('status');
            if (connected) {
                statusDiv.className = 'status connected';
                statusDiv.textContent = '‚úÖ Connected to Realtime';
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.textContent = '‚ö†Ô∏è Disconnected';
            }
        }
        
        // Connect to realtime
        function connect() {
            channel = supabase
                .channel('posts-changes')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'posts' },
                    (payload) => {
                        // Use debounced version to prevent excessive updates
                        addEventDebounced(payload.eventType, {
                            new: payload.new,
                            old: payload.old
                        });
                    }
                )
                .subscribe((status) => {
                    console.log('Subscription status:', status);
                    if (status === 'SUBSCRIBED') {
                        activeChannels.push('posts-changes');
                        updateStats();
                        updateStatus(true);
                        document.getElementById('connectBtn').disabled = true;
                        document.getElementById('disconnectBtn').disabled = false;
                    }
                });
            
            // Handle errors
            channel.on('error', (error) => {
                console.error('Channel error:', error);
                addEvent('ERROR', { error: error.message });
            });
        }
        
        // Disconnect from realtime
        async function disconnect() {
            if (channel) {
                await supabase.removeChannel(channel);
                activeChannels = [];
                channel = null;
                updateStats();
                updateStatus(false);
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
            }
        }
        
        // Clear events display
        function clearEvents() {
            document.getElementById('events').innerHTML = '<em>No events yet...</em>';
            eventCount = 0;
            throttledCount = 0;
            updateStats();
        }
        
        // Event listeners
        document.getElementById('connectBtn').addEventListener('click', connect);
        document.getElementById('disconnectBtn').addEventListener('click', disconnect);
        document.getElementById('clearBtn').addEventListener('click', clearEvents);
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', disconnect);
        
        console.log('üí° To test this example:');
        console.log('1. Update SUPABASE_URL and SUPABASE_ANON_KEY above');
        console.log('2. Click "Connect"');
        console.log('3. Make changes to the posts table in Supabase Studio');
        console.log('4. Watch realtime events appear below!');
    </script>
</body>
</html>
