#!/usr/bin/env bash

set -e

# lint-and-test: Run linting and testing checks
# This script runs ruff for Python linting, pytest for Python tests,
# and TypeScript type checking if applicable.

echo "üîç Running linting and testing checks..."
echo ""

# Detect project type
has_python=false
has_typescript=false

if [ -f "pyproject.toml" ] || [ -f "setup.py" ] || [ -f "requirements.txt" ]; then
    has_python=true
fi

if [ -f "tsconfig.json" ] || [ -f "package.json" ]; then
    has_typescript=true
fi

exit_code=0

# Python checks
if [ "$has_python" = true ]; then
    echo "üì¶ Python project detected"

    # Check if ruff is available
    if command -v ruff &> /dev/null; then
        echo "üîç Running ruff linter..."
        if ruff check . --exit-zero; then
            echo "‚úÖ Ruff linting passed"
        else
            echo "‚ö†Ô∏è  Ruff found issues (non-blocking)"
            exit_code=1
        fi
        echo ""
    else
        echo "‚ö†Ô∏è  ruff not found, skipping Python linting"
        echo "   Install with: pip install ruff"
        echo ""
    fi

    # Check if pytest is available
    if command -v pytest &> /dev/null; then
        echo "üß™ Running pytest..."
        if pytest --tb=short -q; then
            echo "‚úÖ Tests passed"
        else
            echo "‚ö†Ô∏è  Tests failed (non-blocking)"
            exit_code=1
        fi
        echo ""
    else
        echo "‚ö†Ô∏è  pytest not found, skipping tests"
        echo "   Install with: pip install pytest"
        echo ""
    fi
else
    echo "‚ÑπÔ∏è  No Python project detected, skipping Python checks"
    echo ""
fi

# TypeScript checks
if [ "$has_typescript" = true ]; then
    echo "üìò TypeScript project detected"

    # Check if tsc is available
    if command -v tsc &> /dev/null; then
        echo "üîç Running TypeScript type checking..."
        if tsc --noEmit; then
            echo "‚úÖ TypeScript type checking passed"
        else
            echo "‚ö†Ô∏è  TypeScript type checking found issues (non-blocking)"
            exit_code=1
        fi
        echo ""
    else
        echo "‚ö†Ô∏è  tsc not found, skipping TypeScript checks"
        echo "   Install with: npm install -g typescript"
        echo ""
    fi
else
    echo "‚ÑπÔ∏è  No TypeScript project detected, skipping TypeScript checks"
    echo ""
fi

# Summary
if [ $exit_code -eq 0 ]; then
    echo "‚ú® All checks passed!"
else
    echo "‚ö†Ô∏è  Some checks found issues (non-blocking)"
fi

# Always exit 0 to not block the workflow
exit 0
