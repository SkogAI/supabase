#!/usr/bin/env bash

# claude-status - View branch activity and status by prefix across the repo
#
# This tool shows:
# - Recent issues/PRs where @claude was mentioned (always shown)
# - All branches by prefix and their status
# - What's in progress vs completed
#
# Usage: claude-status [--prefix PREFIX]
# Example: claude-status --prefix copilot/

set -euo pipefail

# Optional prefix filter (empty means all branches)
PREFIX=""

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -p|--prefix)
            PREFIX="$2"
            shift 2
            ;;
        -h|--help)
            cat << EOF
Usage: claude-status [OPTIONS]

View branch activity and status across the repository.

OPTIONS:
    -p, --prefix PREFIX    Optional: Only show branches with this prefix
    -h, --help            Show this help message

EXAMPLES:
    # Show all branches
    claude-status

    # Show only claude/* branches
    claude-status --prefix claude/

    # Show only copilot/* branches
    claude-status --prefix copilot/

NOTE: Always shows @claude mentions in issues/PRs regardless of prefix.

EOF
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Colors for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly CYAN='\033[0;36m'
readonly BOLD='\033[1m'
readonly NC='\033[0m' # No Color

# Check if gh CLI is available
if ! command -v gh &> /dev/null; then
    echo -e "${RED}Error: GitHub CLI (gh) is not installed.${NC}"
    echo "Please install it from: https://cli.github.com/"
    exit 1
fi

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo -e "${RED}Error: Not in a git repository${NC}"
    exit 1
fi

# Get repository information
REPO=$(gh repo view --json nameWithOwner -q .nameWithOwner 2>/dev/null || echo "")
if [ -z "$REPO" ]; then
    echo -e "${RED}Error: Could not determine repository${NC}"
    exit 1
fi

echo -e "${BOLD}${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${BOLD}${CYAN}   Branch Activity Status for ${REPO}${NC}"
if [ -n "$PREFIX" ]; then
    echo -e "${BOLD}${CYAN}   Filter: ${PREFIX}*${NC}"
else
    echo -e "${BOLD}${CYAN}   Showing: All branches${NC}"
fi
echo -e "${BOLD}${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

# Section 1: Branches
if [ -n "$PREFIX" ]; then
    echo -e "${BOLD}${BLUE}üìå ${PREFIX}* Branches${NC}"
else
    echo -e "${BOLD}${BLUE}üìå All Branches${NC}"
fi
echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"

# Fetch latest from remote
git fetch --quiet origin 2>/dev/null || true

# Get branches, optionally filtered by prefix
if [ -n "$PREFIX" ]; then
    # Escape special regex characters in PREFIX
    ESCAPED_PREFIX=$(echo "$PREFIX" | sed 's|/|\\/|g')
    BRANCHES=$(git branch -a | rg "(^|\\s+)${ESCAPED_PREFIX}" | sed 's/^[* ]*//; s/remotes\/origin\///' | sort -u)
else
    # Get all branches except master/main
    default_branch=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5 2>/dev/null || echo "master")
    BRANCHES=$(git branch -a | sed 's/^[* ]*//; s/remotes\/origin\///' | grep -v "^${default_branch}$" | grep -v "^HEAD" | sort -u)
fi

if [ -z "$BRANCHES" ]; then
    echo -e "${YELLOW}  No branches found${NC}"
else
    while IFS= read -r branch; do
        # Get the last commit on this branch
        LAST_COMMIT=$(git log -1 --format="%h - %s" "origin/$branch" 2>/dev/null || git log -1 --format="%h - %s" "$branch" 2>/dev/null || echo "No commits")
        LAST_DATE=$(git log -1 --format="%ar" "origin/$branch" 2>/dev/null || git log -1 --format="%ar" "$branch" 2>/dev/null || echo "")

        # Check if there's an associated PR
        PR_INFO=$(gh pr list --head "$branch" --json number,state,title --jq '.[0] | "\(.number)|\(.state)|\(.title)"' 2>/dev/null || echo "")

        if [ -n "$PR_INFO" ] && [ "$PR_INFO" != "null" ]; then
            PR_NUM=$(echo "$PR_INFO" | cut -d'|' -f1)
            PR_STATE=$(echo "$PR_INFO" | cut -d'|' -f2)
            PR_TITLE=$(echo "$PR_INFO" | cut -d'|' -f3)

            if [ "$PR_STATE" = "MERGED" ]; then
                STATUS="${GREEN}‚úì Merged${NC}"
            elif [ "$PR_STATE" = "CLOSED" ]; then
                STATUS="${RED}‚úó Closed${NC}"
            elif [ "$PR_STATE" = "OPEN" ]; then
                STATUS="${YELLOW}‚óâ In Progress${NC}"
            else
                STATUS="${YELLOW}? Unknown${NC}"
            fi

            echo -e "  ${BOLD}${branch}${NC} - $STATUS"
            echo -e "    PR #${PR_NUM}: ${PR_TITLE}"
            echo -e "    ${LAST_COMMIT}"
            echo -e "    ${LAST_DATE}"
        else
            # No PR found - check if branch is active
            if git show-ref --verify --quiet "refs/heads/$branch" || git show-ref --verify --quiet "refs/remotes/origin/$branch"; then
                echo -e "  ${BOLD}${branch}${NC} - ${YELLOW}‚óâ No PR yet${NC}"
                echo -e "    ${LAST_COMMIT}"
                echo -e "    ${LAST_DATE}"
            fi
        fi
        echo ""
    done <<< "$BRANCHES"
fi

echo ""

# Section 2: Recent Issues with @claude mentions
echo -e "${BOLD}${BLUE}üí¨ Recent Issues with @claude Mentions${NC}"
echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"

ISSUES=$(gh issue list --search "@claude" --json number,title,state,updatedAt,author --limit 10 2>/dev/null || echo "[]")

if [ "$ISSUES" = "[]" ] || [ -z "$ISSUES" ]; then
    echo -e "${YELLOW}  No issues found with @claude mentions${NC}"
else
    echo "$ISSUES" | jq -r '.[] |
        if .state == "OPEN" then
            "  #\(.number) - [\u001b[32mOPEN\u001b[0m] \(.title)\n    by @\(.author.login) ‚Ä¢ Updated \(.updatedAt | fromdateiso8601 | strflocaltime("%Y-%m-%d %H:%M"))"
        else
            "  #\(.number) - [\u001b[31mCLOSED\u001b[0m] \(.title)\n    by @\(.author.login) ‚Ä¢ Updated \(.updatedAt | fromdateiso8601 | strflocaltime("%Y-%m-%d %H:%M"))"
        end' 2>/dev/null || echo "$ISSUES" | jq -r '.[] | "  #\(.number) - [\(.state)] \(.title)\n    by @\(.author.login)"'
fi

echo ""

# Section 3: Recent PRs with @claude mentions
echo -e "${BOLD}${BLUE}üîÄ Recent PRs with @claude Mentions${NC}"
echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"

PRS=$(gh pr list --search "@claude" --json number,title,state,updatedAt,author --limit 10 2>/dev/null || echo "[]")

if [ "$PRS" = "[]" ] || [ -z "$PRS" ]; then
    echo -e "${YELLOW}  No PRs found with @claude mentions${NC}"
else
    echo "$PRS" | jq -r '.[] |
        if .state == "OPEN" then
            "  #\(.number) - [\u001b[33mOPEN\u001b[0m] \(.title)\n    by @\(.author.login) ‚Ä¢ Updated \(.updatedAt | fromdateiso8601 | strflocaltime("%Y-%m-%d %H:%M"))"
        elif .state == "MERGED" then
            "  #\(.number) - [\u001b[32mMERGED\u001b[0m] \(.title)\n    by @\(.author.login) ‚Ä¢ Updated \(.updatedAt | fromdateiso8601 | strflocaltime("%Y-%m-%d %H:%M"))"
        else
            "  #\(.number) - [\u001b[31mCLOSED\u001b[0m] \(.title)\n    by @\(.author.login) ‚Ä¢ Updated \(.updatedAt | fromdateiso8601 | strflocaltime("%Y-%m-%d %H:%M"))"
        end' 2>/dev/null || echo "$PRS" | jq -r '.[] | "  #\(.number) - [\(.state)] \(.title)\n    by @\(.author.login)"'
fi

echo ""

# Section 4: Summary
echo -e "${BOLD}${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
TOTAL_BRANCHES=$(echo "$BRANCHES" | grep -c . || echo "0")
OPEN_PRS=$(echo "$PRS" | jq '[.[] | select(.state == "OPEN")] | length' 2>/dev/null || echo "0")
OPEN_ISSUES=$(echo "$ISSUES" | jq '[.[] | select(.state == "OPEN")] | length' 2>/dev/null || echo "0")

echo -e "${BOLD}Summary:${NC}"
if [ -n "$PREFIX" ]; then
    echo -e "  ‚Ä¢ ${PREFIX}* branches: ${BOLD}${TOTAL_BRANCHES}${NC}"
else
    echo -e "  ‚Ä¢ Total branches: ${BOLD}${TOTAL_BRANCHES}${NC}"
fi
echo -e "  ‚Ä¢ Open @claude issues: ${BOLD}${OPEN_ISSUES}${NC}"
echo -e "  ‚Ä¢ Open @claude PRs: ${BOLD}${OPEN_PRS}${NC}"
echo -e "${BOLD}${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
