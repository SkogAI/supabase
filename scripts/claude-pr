#!/usr/bin/env bash

# claude-pr: Quick Claude PR Creator
# Creates a pull request from the current branch with @claude mention

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if gh CLI is installed
if ! command -v gh &> /dev/null; then
    echo -e "${RED}Error: GitHub CLI (gh) is not installed.${NC}"
    echo "Please install it from: https://cli.github.com/"
    exit 1
fi

# Check if we're in a git repository
if ! git rev-parse --is-inside-work-tree &> /dev/null; then
    echo -e "${RED}Error: Not in a git repository.${NC}"
    exit 1
fi

# Get the current branch
CURRENT_BRANCH=$(git branch --show-current)

if [ -z "$CURRENT_BRANCH" ]; then
    echo -e "${RED}Error: Could not determine current branch.${NC}"
    exit 1
fi

# Check if we're on main/master
if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
    echo -e "${RED}Error: Cannot create PR from main/master branch.${NC}"
    echo "Please create a feature branch first."
    exit 1
fi

# Get the task description from arguments
if [ $# -eq 0 ]; then
    echo -e "${RED}Error: No task description provided.${NC}"
    echo "Usage: claude-pr \"your task description for Claude\""
    echo "Example: claude-pr \"review this refactoring for security issues\""
    exit 1
fi

TASK_DESCRIPTION="$*"

# Determine the default branch (main or master)
DEFAULT_BRANCH=$(gh repo view --json defaultBranchRef --jq '.defaultBranchRef.name' 2>/dev/null || echo "main")

# Create PR title from branch name (convert hyphens/underscores to spaces and capitalize)
PR_TITLE=$(echo "$CURRENT_BRANCH" | sed 's/[-_]/ /g' | sed 's/\b\(.\)/\u\1/g')

# Create PR body with @claude mention
PR_BODY="@claude ${TASK_DESCRIPTION}

---
*Created with claude-pr tool*"

echo -e "${GREEN}Creating PR from ${CURRENT_BRANCH} to ${DEFAULT_BRANCH}...${NC}"
echo -e "${YELLOW}Task: ${TASK_DESCRIPTION}${NC}"

# Push current branch to remote if needed
echo "Ensuring branch is pushed to remote..."
git push -u origin "$CURRENT_BRANCH" 2>/dev/null || true

# Create the PR
if gh pr create \
    --base "$DEFAULT_BRANCH" \
    --head "$CURRENT_BRANCH" \
    --title "$PR_TITLE" \
    --body "$PR_BODY"; then

    echo -e "${GREEN}✓ Pull request created successfully!${NC}"
    echo -e "${GREEN}✓ Claude workflow will be triggered automatically.${NC}"
else
    echo -e "${RED}Error: Failed to create pull request.${NC}"
    exit 1
fi
